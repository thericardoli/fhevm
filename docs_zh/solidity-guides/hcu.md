# FHEVM 中的同态复杂度单位（“HCU”）

本指南介绍了如何在 FHEVM 上的智能合约中使用全同态加密（FHE）操作。了解 HCU 对于设计高效的机密智能合约至关重要。

## 概述

与标准的以太坊操作相比，FHEVM 中的 FHE 操作计算量更大，因为它们需要复杂的数学计算来维护隐私和安全。为了管理计算负载并防止潜在的拒绝服务攻击，FHEVM 实现了一个名为**同态复杂度单位（“HCU”）**的计量系统。

为了表示这种复杂性，我们引入了**同态复杂度单位（“HCU”）**。在 Solidity 中，每个 FHE 操作都会根据硬件计算的操作计算复杂性消耗一定数量的 HCU。由于 FHE 交易是符号化的，这有助于防止区块链之外的资源耗尽。

为此，有一个名为 `HCULimit` 的合约，它监控每个交易的 HCU 消耗并强制执行两个关键限制：

- **每个交易的顺序同态操作深度限制**：控制必须按顺序处理的操作的 HCU 使用情况。
- **每个交易的全局同态操作复杂度**：控制可以并行处理的操作的 HCU 使用情况。

如果超出任一限制，交易将被回滚。

## HCU 限制

当前的 devnet 每个交易的 HCU 限制为 **20,000,000**，每个交易的 HCU 深度限制为 **5,000,000**。如果超出任一 HCU 限制，交易将被回滚。

要解决此问题，您必须执行以下操作之一：

- 重构您的代码以减少交易中的 FHE 操作数量。
- 将您的 FHE 操作拆分到多个独立的交易中。

## 常见操作的 HCU 成本

### 布尔运算 (`ebool`)

| 函数名称 | HCU (标量) | HCU (非标量) |
| --- | --- | --- |
| `and` | 22,000 | 25,000 |
| `or` | 22,000 | 24,000 |
| `xor` | 2,000 | 22,000 |
| `not` | - | 2 |
| `select` | - | 55,000 |
| `randEbool` | - | 19,000 |

---

### 无符号整数运算

HCU 随着加密整数类型的位宽而增加。以下是各种加密类型上各种操作的详细成本。

#### **8 位加密整数 (`euint8`)**

| 函数名称 | HCU (标量) | HCU (非标量) |
| --- | --- | --- |
| `add` | 84,000 | 88,000 |
| `sub` | 84,000 | 91,000 |
| `mul` | 122,000 | 150,000 |
| `div` | 210,000 | - |
| `rem` | 440,000 | - |
| `and` | 31,000 | 31,000 |
| `or` | 30,000 | 30,000 |
| `xor` | 31,000 | 31,000 |
| `shr` | 32,000 | 91,000 |
| `shl` | 32,000 | 92,000 |
| `rotr` | 31,000 | 93,000 |
| `rotl` | 31,000 | 91,000 |
| `eq` | 55,000 | 55,000 |
| `ne` | 55,000 | 55,000 |
| `ge` | 52,000 | 63,000 |
| `gt` | 52,000 | 59,000 |
| `le` | 58,000 | 58,000 |
| `lt` | 52,000 | 59,000 |
| `min` | 84,000 | 119,000 |
| `max` | 89,000 | 121,000 |
| `neg` | - | 79,000 |
| `not` | - | 9 |
| `select` | - | 55,000 |
| `randEuint8` | - | 23,000 |

#### **16 位加密整数 (`euint16`)**

| 函数名称 | HCU (标量) | HCU (非标量) |
| --- | --- | --- |
| `add` | 93,000 | 93,000 |
| `sub` | 93,000 | 93,000 |
| `mul` | 193,000 | 222,000 |
| `div` | 302,000 | - |
| `rem` | 580,000 | - |
| `and` | 31,000 | 31,000 |
| `or` | 30,000 | 31,000 |
| `xor` | 31,000 | 31,000 |
| `shr` | 32,000 | 123,000 |
| `shl` | 32,000 | 125,000 |
| `rotr` | 31,000 | 125,000 |
| `rotl` | 31,000 | 125,000 |
| `eq` | 55,000 | 83,000 |
| `ne` | 55,000 | 83,000 |
| `ge` | 55,000 | 84,000 |
| `gt` | 55,000 | 84,000 |
| `le` | 58,000 | 83,000 |
| `lt` | 58,000 | 84,000 |
| `min` | 88,000 | 146,000 |
| `max` | 89,000 | 145,000 |
| `neg` | - | 93,000 |
| `not` | - | 16 |
| `select` | - | 55,000 |
| `randEuint16` | - | 23,000 |

#### **32 位加密整数 (`euint32`)**

| 函数名称 | HCU (标量) | HCU (非标量) |
| --- | --- | --- |
| `add` | 95,000 | 125,000 |
| `sub` | 95,000 | 125,000 |
| `mul` | 265,000 | 328,000 |
| `div` | 438,000 | - |
| `rem` | 792,000 | - |
| `and` | 32,000 | 32,000 |
| `or` | 32,000 | 32,000 |
| `xor` | 32,000 | 32,000 |
| `shr` | 32,000 | 163,000 |
| `shl` | 32,000 | 162,000 |
| `rotr` | 32,000 | 160,000 |
| `rotl` | 32,000 | 163,000 |
| `eq` | 82,000 | 86,000 |
| `ne` | 83,000 | 85,000 |
| `ge` | 84,000 | 118,000 |
| `gt` | 84,000 | 118,000 |
| `le` | 84,000 | 117,000 |
| `lt` | 83,000 | 117,000 |
| `min` | 117,000 | 182,000 |
| `max` | 117,000 | 180,000 |
| `neg` | - | 131,000 |
| `not` | - | 32 |
| `select` | - | 55,000 |
| `randEuint32` | - | 24,000 |

#### **64 位加密整数 (`euint64`)**

| 函数名称 | HCU (标量) | HCU (非标量) |
| --- | --- | --- |
| `add` | 133,000 | 162,000 |
| `sub` | 133,000 | 162,000 |
| `mul` | 365,000 | 596,000 |
| `div` | 715,000 | - |
| `rem` | 1,153,000 | - |
| `and` | 34,000 | 34,000 |
| `or` | 34,000 | 34,000 |
| `xor` | 34,000 | 34,000 |
| `shr` | 34,000 | 209,000 |
| `shl` | 34,000 | 208,000 |
| `rotr` | 34,000 | 209,000 |
| `rotl` | 34,000 | 209,000 |
| `eq` | 83,000 | 120,000 |
| `ne` | 84,000 | 118,000 |
| `ge` | 116,000 | 152,000 |
| `gt` | 117,000 | 152,000 |
| `le` | 119,000 | 149,000 |
| `lt` | 118,000 | 146,000 |
| `min` | 150,000 | 219,000 |
| `max` | 149,000 | 218,000 |
| `neg` | - | 131,000 |
| `not` | - | 63 |
| `select` | - | 55,000 |
| `randEuint64` | - | 24,000 |

#### **128 位加密整数 (`euint128`)**

| 函数名称 | HCU (标量) | HCU (非标量) |
| --- | --- | --- |
| `add` | 172,000 | 259,000 |
| `sub` | 172,000 | 260,000 |
| `mul` | 696,000 | 1,686,000 |
| `div` | 1,225,000 | - |
| `rem` | 1,943,000 | - |
| `and` | 37,000 | 37,000 |
| `or` | 37,000 | 37,000 |
| `xor` | 37,000 | 37,000 |
| `shr` | 37,000 | 272,000 |
| `shl` | 37,000 | 272,000 |
| `rotr` | 37,000 | 283,000 |
| `rotl` | 37,000 | 278,000 |
| `eq` | 117,000 | 122,000 |
| `ne` | 117,000 | 122,000 |
| `ge` | 149,000 | 210,000 |
| `gt` | 150,000 | 218,000 |
| `le` | 150,000 | 218,000 |
| `lt` | 149,000 | 215,000 |
| `min` | 186,000 | 289,000 |
| `max` | 180,000 | 290,000 |
| `neg` | - | 168,000 |
| `not` | - | 130 |
| `select` | - | 57,000 |
| `randEuint128` | - | 25,000 |

#### **256 位加密整数 (`euint256`)**

| 函数名称 | HCU (标量) | HCU (非标量) |
| --- | --- | --- |
| `and` | 38,000 | 38,000 |
| `or` | 38,000 | 38,000 |
| `xor` | 39,000 | 39,000 |
| `shr` | 38,000 | 369,000 |
| `shl` | 39,000 | 378,000 |
| `rotr` | 40,000 | 375,000 |
| `rotl` | 38,000 | 378,000 |
| `eq` | 118,000 | 152,000 |
| `ne` | 117,000 | 150,000 |
| `neg` | - | 269,000 |
| `not` | - | 130 |
| `select` | - | 108,000 |
| `randEuint256` | - | 30,000 |

#### **加密地址 (`euint160`)**

当使用 `eaddress`（内部表示为 `euint160`）时，相等和不相等检查以及选择的 HCU 成本如下：

| 函数名称 | HCU (标量) | HCU (非标量) |
| --- | --- | --- |
| `eq` | 115,000 | 125,000 |
| `ne` | 115,000 | 124,000 |
| `select` | - | 83,000 |

## 其他操作

| 函数名称 | HCU |
| --- | --- |
| `cast` | 32 |
| `trivialEncrypt` | 32 |
| `randBounded` | 23,000-30,000 |
