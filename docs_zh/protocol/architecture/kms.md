# KMS

本文档解释了 Zama 协议的关键组件之一——密钥管理服务（KMS），它负责安全地生成、管理和使用 FHE 密钥，以启用机密智能合约。

## 什么是 KMS？

KMS 是一个由多个节点（也称为“参与方”）组成的分散式网络，它们运行一个 MPC（多方计算）协议：

- 安全地生成全局 FHE 密钥
- 为公共和用户定向解密安全地解密密文
- 支持零知识证明基础设施
- 管理符合 NIST 标准的密钥生命周期

它完全在链下工作，但通过网关进行协调，网关启动并跟踪所有与密钥相关的操作。这种权力的分离确保了强大的分散化和可审计性。

## 主要职责

### FHE 阈值密钥生成

- KMS 安全地生成一个在所有主机链上使用的全局公钥/私钥对。
- 该密钥支持可组合性——加密数据可以在合约和链之间共享。
- FHE 私钥不能被单个参与方直接访问；相反，它在 MPC 节点之间进行秘密共享。

该系统遵循 NIST SP 800-57 密钥生命周期模型，管理密钥状态，如活动、暂停、停用和销毁，以确保适当的轮换和前向安全性。

### 通过 MPC 进行阈值解密

KMS 使用阈值解密协议执行解密——至少需要最少数量的 MPC 参与方（例如，13 个中的 9 个）参与协议才能稳健地解密一个值。

- 这可以防止泄露：没有单个参与方可以访问完整的密钥。对手需要控制超过阈值的 KMS 节点才能影响系统。
- 该协议支持：
  - 公共解密（例如，对于智能合约）
  - 用户解密（私下返回，仅为用户访问而重新加密）

所有解密操作输出都由每个节点签名，并且输出可以在链上验证以实现完全可审计性。

### ZK 证明支持

KMS 生成验证用户提交加密值时零知识知识证明（ZKPoK）所需的通用参考字符串（CRS）。

这确保加密输入是有效的且格式正确的，并且用户知道提交的输入密文中包含的明文。

## 安全架构

### 基于 MPC 的密钥共享

- KMS 目前使用 13 个 MPC 节点，由不同的信誉良好的组织运营。
- 私钥使用阈值秘密共享进行分割。
- 节点之间的通信使用 gRPC 进行 mTLS 安全保护。

### 诚实多数假设

- 只要最多 1/3 的节点恶意行事，该协议就能抵御恶意行为者。
- 即使某些节点离线或行为不当，它也支持保证的输出交付。

### 安全执行环境

每个 MPC 节点默认在 AWS Nitro Enclave（一个安全执行环境）内运行，该环境甚至可以防止节点运营商访问自己的密钥共享。
这种设计降低了内部风险，例如未经授权的密钥重构或共享的出售。

### 可通过网关审计

- 所有操作都通过网关广播并记录为区块链事件。
- KMS 响应已签名，允许智能合约和用户以加密方式验证结果。

### 密钥生命周期管理

KMS 遵循 NIST SP 800-57 的正式密钥生命周期：

| 状态 | 描述 |
| --- | --- |
| 预激活 | 密钥已创建但尚未使用。 |
| 活动 | 密钥用于加密和解密。 |
| 暂停 | 在轮换期间临时更换。仍可用于解密。 |
| 停用 | 已存档；仅用于解密。 |
| 已泄露 | 标记为滥用；仅允许解密。 |
| 已销毁 | 密钥材料被永久删除。 |

KMS 支持使用 FHE 进行密钥切换，允许在轮换期间安全地在密钥之间传输密文。这在密钥更新之间保持了互操作性。

### 备份和恢复

除了通过 MPC 实现稳健性外，KMS 还提供了一个托管备份系统：

- 每个 MPC 节点将其密钥共享拆分为加密片段，并将它们分发给独立的保管人。
- 如果共享丢失，法定人数的保管人可以协作恢复它，即使有几个 MPC 节点离线也能确保恢复。
- 这种方法保证了业务连续性和对中断的弹性。
- 所有恢复操作都需要法定人数的运营商，并且在链上完全可审计。

### 工作流程示例：公共解密

1. 智能合约通过预言机请求解密。
2. 网关验证权限（即合约被允许解密密文）并发出一个事件。
3. KMS 参与方检索密文，对其进行验证，并运行 MPC 解密协议以共同计算明文并对结果进行签名。
4. 一旦法定人数就明文结果达成一致，它就会被发布（带有签名）。
5. 预言机将明文发布回链上，合约可以使用 KMS 签名验证其真实性。
