# KMS

本文档解释了 Zama 协议的关键组件之一——密钥管理服务（KMS），负责安全生成、管理和使用支持机密智能合约所需的 FHE 密钥。

## 什么是 KMS？

KMS 是一个由多个节点（也称为"参与方"）组成的去中心化网络，运行 MPC（多方计算）协议：

- 安全生成全局 FHE 密钥
- 为公共和用户目标解密安全解密密文
- 支持零知识证明基础设施
- 符合 NIST 标准管理密钥生命周期

它完全在链外工作，但通过网关协调，网关启动并跟踪所有与密钥相关的操作。这种权力分离确保了强大的去中心化和可审计性。

## 关键职责

### FHE 门限密钥生成

- KMS 安全生成用于所有主机链的全局公钥/私钥对。
- 此密钥支持可组合性——加密数据可以在合约和链之间共享。
- 私有 FHE 密钥从不直接被单个参与方访问；相反，它在 MPC 节点之间秘密共享。

该系统遵循 NIST SP 800-57 密钥生命周期模型，管理诸如活动、暂停、停用和销毁等密钥状态，以确保适当的轮换和前向安全性。

### 通过 MPC 进行门限解密

KMS 使用门限解密协议执行解密——至少需要最少数量的 MPC 参与方（例如，13 个中的 9 个）参与协议才能稳健地解密值。

- 这可以防止妥协：没有单个参与方可以访问完整的密钥。攻击者需要控制超过 KMS 节点阈值才能影响系统。
- 该协议支持：
  - 公共解密（例如，用于智能合约）
  - 用户解密（私密返回，仅为用户重新加密以供访问）

所有解密操作输出均由每个节点签名，输出可以在链上验证以实现完全可审计性。

### ZK 证明支持

KMS 生成通用参考字符串（CRS），用于在用户提交加密值时验证知识零知识证明（ZKPoK）。

这确保加密输入是有效且格式良好的，并且用户知道提交的输入密文中包含的明文。

## 安全架构

### 基于 MPC 的密钥共享

- KMS 目前使用 13 个 MPC 节点，由不同的知名组织运营。
- 私钥使用门限秘密共享进行分割。
- 节点之间的通信使用 mTLS 和 gRPC 进行保护。

### 诚实多数假设

- 只要最多 1/3 的节点恶意行事，该协议就能抵御恶意行为者。
- 即使某些节点离线或行为不当，它也支持保证输出交付。

### 安全执行环境

默认情况下，每个 MPC 节点在 AWS Nitro Enclave 内运行，这是一个安全执行环境，甚至可以防止节点操作员访问他们自己的密钥份额。
这种设计减轻了内部风险，例如未经授权的密钥重建或出售份额。

### 通过网关可审计

- 所有操作都通过网关广播并记录为区块链事件。
- KMS 响应经过签名，允许智能合约和用户以密码学方式验证结果。

### 密钥生命周期管理

KMS 遵循正式的密钥生命周期，符合 NIST SP 800-57：

| 状态          | 描述                                                        |
| -------------- | ------------------------------------------------------------------ |
| 预激活 | 密钥已创建但未使用。                                     |
| 活动         | 密钥用于加密和解密。                         |
| 暂停      | 在轮换期间暂时替换。仍可用于解密。 |
| 停用    | 已归档；仅用于解密。                                |
| 已泄露    | 标记为滥用；仅允许解密。                       |
| 已销毁      | 密钥材料已永久删除。                               |

KMS 支持使用 FHE 进行密钥切换，允许在轮换期间在密钥之间安全传输密文。这在密钥更新期间保持互操作性。

### 备份和恢复

除了通过 MPC 提供的稳健性外，KMS 还提供托管备份系统：

- 每个 MPC 节点将其密钥份额分割为加密片段，并将其分发给独立的托管人。
- 如果份额丢失，托管人的法定人数可以协作恢复它，确保即使多个 MPC 节点离线也能恢复。
- 这种方法保证了业务连续性和对中断的弹性。
- 所有恢复操作都需要操作员的法定人数，并且在链上完全可审计。

### 工作流示例：公共解密

1. 智能合约通过预言机请求解密。
2. 网关验证权限（即合约被允许解密密文）并发出事件。
3. KMS 参与方检索密文、验证它并运行 MPC 解密协议以共同计算明文并签署其结果。
4. 一旦法定人数就明文结果达成一致，就会发布（带签名）。
5. 预言机将明文发布回链上，合约可以使用 KMS 签名验证真实性。
