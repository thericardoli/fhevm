# 协处理器

本文档解释了 Zama 协议的关键组件之一——协处理器，即 Zama 协议的链下计算引擎。

## 什么是协处理器？

协处理器代表对加密数据进行操作的智能合约执行繁重的加密操作——特别是全同态加密（FHE）计算。作为分散式计算层，协处理器将符号化的链上逻辑与现实世界中的加密执行联系起来。

协处理器与网关协同工作，验证加密输入，执行 FHE 指令，并维护访问权限的同步，特别是：

- 监听主机链和网关发出的事件。
- 对密文执行 FHE 计算（`add`、`mul`、`div`、`cmp` 等）。
- 验证加密输入和正确性的 ZK 证明。
- 维护和更新主机链访问控制列表（ACL）的副本。
- 存储和提供加密数据以进行解密或桥接。

每个协处理器独立执行任务并发布可验证的结果，从而实现可公开审计和水平可扩展的机密计算基础设施。

## 协处理器的职责

### 加密输入验证

当用户向网关提交加密值时，每个协处理器：

- 验证相关的零知识知识证明（ZKPoK）。
- 从打包的提交中提取并解包单个密文。
- 在派生的句柄下存储密文。
- 对验证过的句柄进行签名，嵌入用户和合约元数据。
- 将签名的数据发送回网关以达成共识。

这确保只有有效的、格式正确的加密值才能进入系统。

### FHE 计算执行

当智能合约对加密值执行函数时，链上逻辑会发出符号计算事件。
每个协处理器：

- 从其运行的主机链节点读取这些事件。
- 从其存储中获取相关的密文。
- 使用 TFHE-rs 库执行所需的 FHE 操作（例如，add、mul、select）。
- 在确定性派生的句柄下存储生成的密文。
- 可选地将密文的承诺（摘要）发布到网关以进行验证。

这减轻了主机链的昂贵计算，同时保持了完全的确定性和可审计性。

### ACL 复制

协处理器复制主机合约的访问控制列表（ACL）逻辑。它们：

- 监听 `Allowed` 和 `AllowedForDecryption` 事件。
- 将更新推送到网关。

这确保了访问权限的分散执行，从而能够正确处理解密、桥接和合约交互。

### 密文承诺

为确保可验证性并减少不当行为，每个协处理器：

- 在处理 `Allowed` 事件时，对密文摘要（通过哈希）进行承诺。
- 将这些承诺发布到网关。
- 启用 FHE 计算的外部验证。

这对于欺诈证明机制和最终削减恶意或故障运营商至关重要。

### 桥接和解密支持

协处理器协助：

- 通过生成新的句柄和签名，在主机链之间桥接加密值。
- 使用 Switch-n-Squash 等操作为公共和用户解密准备密文，以规范化 KMS 的密文。

这些角色有助于维护跨链互操作性，并为用户和智能合约启用保护隐私的数据访问。

## 安全和信任假设

协处理器被设计为最小信任和可公开验证。它们执行的每个 FHE 计算或输入验证都附有加密承诺（哈希摘要）和签名，允许任何人独立验证正确性。

该协议依赖于多数诚实假设：只要超过 50% 的协处理器是诚实的，结果就是有效的。网关聚合响应，并且只有在达成多数共识时才接受输出。

为了强制执行诚实行为，协处理器必须抵押 $ZAMA 代币，如果被发现行为不当——无论是通过自动检查还是基于治理的欺诈证明——都将受到削减。

该模型通过透明度确保正确性，通过分散化确保弹性，通过经济激励确保完整性。

## 架构和可伸缩性

协处理器架构包括：

- 主机链和网关的事件监听器
- FHE 和 ACL 更新作业的任务队列
- 并行处理任务的工作线程
- 用于密文可用性的公共存储层（例如，S3）

这种模块化设置支持水平扩展：增加更多的工作人员或机器可以提高吞吐量。符号化
计算和延迟执行也确保了链上的低 gas 成本。
