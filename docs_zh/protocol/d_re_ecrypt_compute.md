# 加密、解密和计算

本节介绍了 FHEVM 系统中的核心加密操作，涵盖了数据如何被加密、处理和解密——同时通过全同态加密（FHE）确保完全的机密性。

该架构强制执行端到端加密，协调前端、智能合约、协处理器和通过阈值 MPC 操作的安全密钥管理系统（KMS）之间的密钥流。

## **FHE 密钥及其位置**

1. **公钥**：
   - **位置**：通过前端 SDK 公开。
   - **作用**：在与区块链进行任何交互之前加密用户输入。
2. **私钥**：
   - **位置**：使用阈值 MPC 在密钥管理系统（KMS）中得到保护。
   - **作用**：在必要时用于解密数据——例如向用户或智能合约显示明文。
3. **评估密钥**：
   - **位置**：托管在协处理器上。
   - **作用**：用途：在不解密任何数据的情况下实现加密计算。

<figure><img src="../.gitbook/assets/architecture.png" alt="FHE 密钥概述"><figcaption><p>FHEVM 架构的高级概述</p></figcaption></figure>

## **工作流程：加密、解密和处理**

### **加密**

加密是与 FHEVM 系统进行任何交互的起点，确保数据在传输或处理之前受到保护。

- **工作原理**：
  1. 前端或客户端应用程序使用公钥加密用户提供的明文输入，并生成底层明文的知识证明。
  2. 生成的密文和证明被提交到网关进行验证。
  3. 协处理器验证证明并将密文存储在链下，返回可用作链上参数的句柄和签名。
- **数据流**：
  - **来源**：前端。
  - **目的地**：协处理器（用于处理）。

<figure><img src="../.gitbook/assets/encrypt.png" alt="解密" width="600"><figcaption></figcaption></figure>

您可以在[我们的加密指南](solidity-guides/inputs.md)中阅读有关实现细节的信息。

### **计算**

加密计算是使用协处理器上的**评估密钥**执行的。

- **工作原理**：
  1. 智能合约发出 FHE 操作事件作为符号指令。
  2. 这些事件由协处理器接收，协处理器使用评估密钥单独评估每个操作，而无需解密数据。
  3. 生成的密文保留在协处理器数据库中，而只有一个句柄返回到链上。
- **数据流**：
  - **来源**：区块链智能合约（通过符号执行）。
  - **处理**：协处理器（使用评估密钥）。
  - **目的地**：区块链（更新的密文）。

<figure><img src="../.gitbook/assets/computation.png" alt="计算"><figcaption></figcaption></figure>

### **解密**

FHEVM 系统支持两种解密：

1. 当链上需要明文时使用的公共解密。
   1. 合约发出解密请求。
   2. 网关验证并将其转发到 KMS。
   3. 明文通过回调返回给智能合约。
2. 当用户需要私下访问解密值时使用的用户解密。
   1. 用户在本地生成密钥对。
   2. 对其公钥进行签名并向网关提交请求。
   3. 网关验证请求并将其转发到 KMS。
   4. KMS 解密密文并使用用户的公钥对其进行加密。
   5. 用户接收密文并在本地解密。

<figure><img src="../.gitbook/assets/decryption.png" alt="解密"><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/asyncDecrypt.png" alt="解密"><figcaption><p>解密</p></figcaption></figure>
您可以在[我们的解密指南](solidity-guides/decryption/decrypt.md)中阅读有关实现细节的信息。

#### 什么是“用户解密”？

用户解密是一种允许用户或应用程序请求私下访问解密数据的机制——而不会在链上暴露明文。KMS 不会简单地解密，而是使用用户的公钥安全地解密结果，从而允许用户仅在客户端解密。

这保证了：

- 只有请求的用户才能看到明文
- KMS 绝不会泄露解密的值
- 解密的结果不会写入区块链

<figure><img src="../.gitbook/assets/reencryption.png" alt="解密"><figcaption><p>解密过程</p></figcaption></figure>

#### 客户端实现

用户解密是在客户端使用 [`@zama-ai/relayer-sdk`](https://github.com/zama-ai/relayer-sdk/) 库启动的。以下是一般的工作流程：

1. **检索密文**：
   - dApp 在智能合约上调用一个视图函数（例如，`balanceOf`）以获取要解密的密文的句柄。
2. **生成并签署密钥对**：
   - dApp 为用户生成一个密钥对。
   - 用户对公钥进行签名以确保真实性。
3. **提交用户加密请求**：
   - dApp 向网关发出一个交易，提供以下信息：
     - 密文句柄。
     - 用户的公钥。
     - 用户的地址。
     - 智能合约地址。
     - 用户的签名。
   - 交易可以直接从客户端应用程序发送到网关链，也可以通过公开 HTTP 端点以抽象交易处理的中继器路由。
4. **解密加密的密文**：
   - dApp 从网关/中继器接收用户公钥下的加密密文。
   - dApp 使用用户的私钥在本地解密密文。

您可以阅读[我们解释如何使用它的用户解密指南](solidity-guides/decryption/user-decryption.md)。

## **总结**

在这些操作中，FHEVM 组件之间的信息流突出了该系统如何在确保隐私的同时保持可用性：

| 操作 | | |
| --- | --- | --- |
| **加密** | 公钥 | 前端加密数据 → 密文发送到区块链或协处理器 |
| **计算** | 评估密钥 | 协处理器执行智能合约事件中的操作 → 更新的密文 |
| **解密** | 私钥 | 智能合约请求明文 → 网关转发到 KMS → 结果返回到链上 |
| **用户解密** | 私钥和目标密钥 | 用户请求结果 → KMS 解密并使用用户的公钥加密 → 前端在本地解密 |

该架构确保敏感数据在其整个生命周期中保持加密，解密仅在受控、安全的环境中进行。通过分离密钥角色和处理职责，FHEVM 为私有智能合约提供了一个可扩展且强大的框架。
